<!DOCTYPE html>
<html lang="en-us">
    <head><title>John Jarvis</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="The HTML5 Herald" />
<meta name="author" content="" />
<style type="text/css">@font-face {
  font-family: fabfont;
  src: url('/font/DejaVuSansMono.woff2');
  font-display: block;
}

@font-face {
  font-family: fabfont;
  src: url('/font/DejaVuSansMono-Bold.woff2');
  font-weight: bold;
  font-display: block;
}

main h1 {
  font-weight: bold;
  text-transform: uppercase;
  font-size: 1.2rem;
  border-bottom: 1px solid black;
}

html {
  font-size: 14px;
  color: black;
}

body {
  margin: 0;
  padding: 0;
  overflow-x: hidden;
  font-family: fabfont,  monospace;
  background: #F5F5F0;
}

body > * {
  width: 700px;
  margin: 0 auto;
}

table {
  border-collapse: collapse;
}

td, th {
  text-align: left;
}

@media only screen and (width <= 800px) {
  body > * {
    width: auto;
    margin: 0 1.2em;
  }
}

a {
  font-weight: bold;
  color: black;
}

p {
  text-align: justify;
}

img {
  width: 100%;
}

/* index.html */

main {
  line-height: 1.5;
}

main ul {
  list-style: none;
  margin: 0;
  padding: 0;
}

/* header */

header {
  font-weight: bold;
  text-transform: uppercase;
  margin-top: 4ch;
  margin-top: 1em;
  display: flex;
}


header a {
  text-decoration: none;
}

header h2 {
  font-size: 14px;
  width: 50%;
  margin: 0;
  padding: 0;
}

header aside {
  width: 50%;
  text-align: right;
}

header aside ul {
  margin: 0;
  padding: 0;
  list-style: none;
  justify-content: space-between;
}

header aside ul > li {
  display: inline-block;
}

/* articles */

main article aside {
  display: flex;
  margin: 0;
  color: gray;
  font-size: .9em;
}

main article aside ul li a {
  color: gray;
  text-decoration: none;
}

main article aside time {
  display: flex;
  width: 50%;
}

main article aside ul {
  margin: 0;
  padding: 0;
  width: 50%;
  text-align: right;
  list-style: none;
  justify-content: space-between;
}

main article > pre {
  background-color: #e1e1e1;
  overflow-x: auto;
  padding: .8em;
  font-size: .9em;
  box-shadow: 0 -1px 0 #bbb inset;
}

/* code hylights */
main article .highlight pre {
  overflow-x: auto;
  font-size: .8em;
  padding: .8em;
}

main article p code {
    font-weight: bold;
    background-color: #e1e1e1;
    border-radius: 0.5ch;
    padding-left: 0.3ch;
    padding-right: 0.3ch;
}

/* blockquote */

blockquote {
  font-style:italic;
  color: #555;
  padding:1.2em 30px 1.2em 45px;
  border-left:8px solid #696969;
  position: relative;
  background: #EDEDED;
  line-height: 1.6;
}

blockquote p {
  text-align: left;

}

blockquote::before {
  font-family: Arial, Helvetica, sans-serif;
  content: "\201C";
  color: #696969;
  font-size:4em;
  position: absolute;
  left: 10px;
  top: -10px;
}

blockquote::after {
  content: '';
}

@media only screen and (width <= 800px) {
  blockquote {
    margin: 1em 0;
    padding: .5em;
  }
}
</style>
</head>
    <body>
        <header><h2><a href="/"><b>John Jarvis</b></a></h2>
<aside>
  <ul>
    <li><a href="/about/">ABOUT</a></li>
    <li><a href="/contact/">CONTACT</a></li>
    <li><a href="https://jarv.org/index.xml">RSS</a></li>
  </ul>
</aside>
</header>
        <main>
<article>
    <h1>Displaying the percentage of hosts completed during a rolling Ansible Deploy using serial</h1>
    <aside>
  
  <time datetime="2020-10-02T00:00:00Z">Oct 2, 2020</time>
  
  <ul>
    <li>
    </li>
    
    <li>
      <em>
        
        
        <a href="/tags/ansible">#ansible</a>
        
      </em>
    </li>
    
  </ul>
</aside>

    <p>Recently we were looking at enhancing our deployment pipeline so that we run validation checks between every batch that is upgraded. For our VM deployments in Ansible we normally have</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>serial: 10%
</span></span></code></pre></div><p>so that 10% of the fleet is operated on at once, this includes draining from a load balancer before we upgrade the node, and adding it back to the load balancer after.</p>
<p>With Ansible, it doesn&rsquo;t seem like there is any built-in way to get the host percentage, so here is a hacky solution for others who want to do something similar:</p>
<ul>
<li>Initialize a fact to an empty array:</li>
</ul>
<p>If we put this in <code>pre_tasks:</code> you will need to keep in mind it is called on every batch, so you don&rsquo;t want to override it:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#bbb">    </span>- <span style="color:#000080">name</span>:<span style="color:#bbb"> </span>Initialize completed_hosts<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">set_fact</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">completed_hosts</span>:<span style="color:#bbb"> </span><span style="color:#d14">&#34;{{ hostvars[&#39;localhost&#39;][&#39;completed_hosts&#39;] | default(&#39;[]&#39;) }}&#34;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">delegate_to</span>:<span style="color:#bbb"> </span>localhost<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">delegate_facts</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">run_once</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>Another option is initialize it in a play that runs before the play that is operating on hosts, in that case you can just initialize it to an empty array:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#bbb">    </span>- <span style="color:#000080">name</span>:<span style="color:#bbb"> </span>Initialize completed_hosts<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">set_fact</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">completed_hosts</span>:<span style="color:#bbb"> </span>[]<span style="color:#bbb">
</span></span></span></code></pre></div><ul>
<li>In post_tasks, append the current batch to completed_hosts:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>- <span style="color:#000080">name</span>:<span style="color:#bbb"> </span>Appends to completed hosts<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">set_fact</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">completed_hosts</span>:<span style="color:#bbb"> </span><span style="color:#d14">&#34;{{ hostvars[&#39;localhost&#39;][&#39;completed_hosts&#39;] + ansible_play_batch }}&#34;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">delegate_to</span>:<span style="color:#bbb"> </span>localhost<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">delegate_facts</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span></code></pre></div><ul>
<li>Calculate a percentage:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>- <span style="color:#000080">name</span>:<span style="color:#bbb"> </span>Percentage complete<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">debug</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">msg</span>:<span style="color:#bbb"> </span><span style="color:#d14">&#34;Percentage complete: {{ ((hostvars[&#39;localhost&#39;][&#39;completed_hosts&#39;] | length) / (ansible_play_hosts | length) * 100) | int }}%&#34;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">run_once</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">delegate_to</span>:<span style="color:#bbb"> </span>localhost<span style="color:#bbb">
</span></span></span></code></pre></div><p>And here is an example test play:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#000080">name</span>:<span style="color:#bbb"> </span>test<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">gather_facts</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">hosts</span>:<span style="color:#bbb"> </span>some_host_group<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">serial</span>:<span style="color:#bbb"> </span><span style="color:#d14">&#39;10%&#39;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">pre_tasks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>- <span style="color:#000080">debug</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">msg</span>:<span style="color:#bbb"> </span>drain<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>- <span style="color:#000080">name</span>:<span style="color:#bbb"> </span>Initialize completed_hosts<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">set_fact</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">completed_hosts</span>:<span style="color:#bbb"> </span><span style="color:#d14">&#34;{{ hostvars[&#39;localhost&#39;][&#39;completed_hosts&#39;] | default(&#39;[]&#39;) }}&#34;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">delegate_to</span>:<span style="color:#bbb"> </span>localhost<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">delegate_facts</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">run_once</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">tasks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>- <span style="color:#000080">debug</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">msg</span>:<span style="color:#bbb"> </span>deploy<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">post_tasks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>- <span style="color:#000080">debug</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">msg</span>:<span style="color:#bbb"> </span>enable<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>- <span style="color:#000080">name</span>:<span style="color:#bbb"> </span>Appends to completed hosts<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">set_fact</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">completed_hosts</span>:<span style="color:#bbb"> </span><span style="color:#d14">&#34;{{ hostvars[&#39;localhost&#39;][&#39;completed_hosts&#39;] + ansible_play_batch }}&#34;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">delegate_to</span>:<span style="color:#bbb"> </span>localhost<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">delegate_facts</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>- <span style="color:#000080">name</span>:<span style="color:#bbb"> </span>Display current batch<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">debug</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">var</span>:<span style="color:#bbb"> </span>ansible_play_batch<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">delegate_to</span>:<span style="color:#bbb"> </span>localhost<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">run_once</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>- <span style="color:#000080">name</span>:<span style="color:#bbb"> </span>Display completed hosts<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">debug</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">msg</span>:<span style="color:#bbb"> </span><span style="color:#d14">&#34;Percentage complete: {{ ((hostvars[&#39;localhost&#39;][&#39;completed_hosts&#39;] | length) / (ansible_play_hosts | length) * 100) | int}}%&#34;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">run_once</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">delegate_to</span>:<span style="color:#bbb"> </span>localhost<span style="color:#bbb">
</span></span></span></code></pre></div>
</article>


        </main>
        <footer></footer>
    </body>
</html>
