<!DOCTYPE html>
<html lang="en-us">
    <head><title>John Jarvis</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="The HTML5 Herald" />
<meta name="author" content="" />
<style type="text/css">@font-face {
  font-family: fabfont;
  src: url('/font/DejaVuSansMono.woff2');
  font-display: block;
}

@font-face {
  font-family: fabfont;
  src: url('/font/DejaVuSansMono-Bold.woff2');
  font-weight: bold;
  font-display: block;
}

main h1 {
  font-weight: bold;
  text-transform: uppercase;
  font-size: 1.2rem;
  border-bottom: 1px solid black;
}

html {
  font-size: 14px;
  color: black;
}

body {
  margin: 0;
  padding: 0;
  overflow-x: hidden;
  font-family: fabfont,  monospace;
  background: #F5F5F0;
}

body > * {
  width: 700px;
  margin: 0 auto;
}

table {
  border-collapse: collapse;
}

td, th {
  text-align: left;
}

@media only screen and (width <= 800px) {
  body > * {
    width: auto;
    margin: 0 1.2em;
  }
}

a {
  font-weight: bold;
  color: black;
}

p {
  text-align: justify;
}

img {
  width: 100%;
}

/* index.html */

main {
  line-height: 1.5;
}

main ul {
  list-style: none;
  margin: 0;
  padding: 0;
}

/* header */

header {
  font-weight: bold;
  text-transform: uppercase;
  margin-top: 4ch;
  margin-top: 1em;
  display: flex;
}


header a {
  text-decoration: none;
}

header h2 {
  font-size: 14px;
  width: 50%;
  margin: 0;
  padding: 0;
}

header aside {
  width: 50%;
  text-align: right;
}

header aside ul {
  margin: 0;
  padding: 0;
  list-style: none;
  justify-content: space-between;
}

header aside ul > li {
  display: inline-block;
}

/* articles */

main article aside {
  display: flex;
  margin: 0;
  color: gray;
  font-size: .9em;
}

main article aside ul li a {
  color: gray;
  text-decoration: none;
}

main article aside time {
  display: flex;
  width: 50%;
}

main article aside ul {
  margin: 0;
  padding: 0;
  width: 50%;
  text-align: right;
  list-style: none;
  justify-content: space-between;
}

main article > pre {
  background-color: #e1e1e1;
  overflow-x: auto;
  padding: .8em;
  font-size: .9em;
  box-shadow: 0 -1px 0 #bbb inset;
}

/* code hylights */
main article .highlight pre {
  overflow-x: auto;
  font-size: .8em;
  padding: .8em;
}

main article p code {
    font-weight: bold;
    background-color: #e1e1e1;
    border-radius: 0.5ch;
    padding-left: 0.3ch;
    padding-right: 0.3ch;
}

/* blockquote */

blockquote {
  font-style:italic;
  color: #555;
  padding:1.2em 30px 1.2em 45px;
  border-left:8px solid #696969;
  position: relative;
  background: #EDEDED;
  line-height: 1.6;
}

blockquote p {
  text-align: left;

}

blockquote::before {
  font-family: Arial, Helvetica, sans-serif;
  content: "\201C";
  color: #696969;
  font-size:4em;
  position: absolute;
  left: 10px;
  top: -10px;
}

blockquote::after {
  content: '';
}

@media only screen and (width <= 800px) {
  blockquote {
    margin: 1em 0;
    padding: .5em;
  }
}
</style>
</head>
    <body>
        <header><h2><a href="/"><b>John Jarvis</b></a></h2>
<aside>
  <ul>
    <li><a href="/about/">ABOUT</a></li>
    <li><a href="/contact/">CONTACT</a></li>
    <li><a href="https://jarv.org/index.xml">RSS</a></li>
  </ul>
</aside>
</header>
        <main>
<article>
    <h1>Simple highscore tracking with Python / Flask</h1>
    <aside>
  
  <time datetime="2012-12-17T00:00:00Z">Dec 17, 2012</time>
  
  <ul>
    <li>
    </li>
    
    <li>
      <em>
        
        
        <a href="/tags/python">#python</a>
        
      </em>
    </li>
    
  </ul>
</aside>

    <p>Below is a quick tutorial on how flask web framework might be
used for simple highscore tracking. All of the source code the state game <a href="http://github.com/jarv/thestategame">is now on github</a>.</p>
<p>This code will accept an AJAX GET or POST at the end of each game so that scores can be tracked and read. Since the use-cases are simple it&rsquo;s easy to write the tests first:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">StateTestCase</span>(unittest<span style="color:#000;font-weight:bold">.</span>TestCase):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">setUp</span>(<span style="color:#999">self</span>):
</span></span><span style="display:flex;"><span>          <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>db_fd, state<span style="color:#000;font-weight:bold">.</span>app<span style="color:#000;font-weight:bold">.</span>config[<span style="color:#d14">&#39;DATABASE&#39;</span>] <span style="color:#000;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>              tempfile<span style="color:#000;font-weight:bold">.</span>mkstemp()
</span></span><span style="display:flex;"><span>          state<span style="color:#000;font-weight:bold">.</span>app<span style="color:#000;font-weight:bold">.</span>config[<span style="color:#d14">&#39;TESTING&#39;</span>] <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>          <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>app <span style="color:#000;font-weight:bold">=</span> state<span style="color:#000;font-weight:bold">.</span>app<span style="color:#000;font-weight:bold">.</span>test_client()
</span></span><span style="display:flex;"><span>          state<span style="color:#000;font-weight:bold">.</span>init_db()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">tearDown</span>(<span style="color:#999">self</span>):
</span></span><span style="display:flex;"><span>          os<span style="color:#000;font-weight:bold">.</span>close(<span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>db_fd)
</span></span><span style="display:flex;"><span>          os<span style="color:#000;font-weight:bold">.</span>unlink(state<span style="color:#000;font-weight:bold">.</span>app<span style="color:#000;font-weight:bold">.</span>config[<span style="color:#d14">&#39;DATABASE&#39;</span>])
</span></span></code></pre></div><p>This above code will create an sqlite db before each test-case and
remove it when completed.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">test_empty_db</span>(<span style="color:#999">self</span>):
</span></span><span style="display:flex;"><span>      rv <span style="color:#000;font-weight:bold">=</span> <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>app<span style="color:#000;font-weight:bold">.</span>get(<span style="color:#d14">&#39;/d&#39;</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">assert</span> json<span style="color:#000;font-weight:bold">.</span>loads(rv<span style="color:#000;font-weight:bold">.</span>data) <span style="color:#000;font-weight:bold">==</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">test_single_entry</span>(<span style="color:#999">self</span>):
</span></span><span style="display:flex;"><span>      test_data <span style="color:#000;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#d14">&#39;name&#39;</span>: <span style="color:#d14">&#39;john doe&#39;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#d14">&#39;score&#39;</span>: <span style="color:#099">1234</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#d14">&#39;time&#39;</span>: <span style="color:#099">1234</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      rv <span style="color:#000;font-weight:bold">=</span> <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>app<span style="color:#000;font-weight:bold">.</span>post(<span style="color:#d14">&#39;/d&#39;</span>, data<span style="color:#000;font-weight:bold">=</span>test_data)
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">assert</span> <span style="color:#d14">&#39;ok&#39;</span> <span style="color:#000;font-weight:bold">in</span> json<span style="color:#000;font-weight:bold">.</span>loads(rv<span style="color:#000;font-weight:bold">.</span>data)
</span></span><span style="display:flex;"><span>      rv <span style="color:#000;font-weight:bold">=</span> <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>app<span style="color:#000;font-weight:bold">.</span>get(<span style="color:#d14">&#39;/d&#39;</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">assert</span> json<span style="color:#000;font-weight:bold">.</span>loads(rv<span style="color:#000;font-weight:bold">.</span>data) <span style="color:#000;font-weight:bold">==</span> [test_data]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">test_multiple_entries</span>(<span style="color:#999">self</span>):
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">for</span> score <span style="color:#000;font-weight:bold">in</span> <span style="color:#0086b3">range</span>(<span style="color:#099">0</span>, <span style="color:#099">25</span>):
</span></span><span style="display:flex;"><span>          data <span style="color:#000;font-weight:bold">=</span> {<span style="color:#d14">&#39;name&#39;</span>: <span style="color:#d14">&#39;john doe&#39;</span>,
</span></span><span style="display:flex;"><span>                  <span style="color:#d14">&#39;score&#39;</span>: score,
</span></span><span style="display:flex;"><span>                  <span style="color:#d14">&#39;time&#39;</span>: <span style="color:#099">1234</span>}
</span></span><span style="display:flex;"><span>          rv <span style="color:#000;font-weight:bold">=</span> <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>app<span style="color:#000;font-weight:bold">.</span>post(<span style="color:#d14">&#39;/d&#39;</span>, data<span style="color:#000;font-weight:bold">=</span>data)
</span></span><span style="display:flex;"><span>          <span style="color:#000;font-weight:bold">assert</span> <span style="color:#d14">&#39;ok&#39;</span> <span style="color:#000;font-weight:bold">in</span> json<span style="color:#000;font-weight:bold">.</span>loads(rv<span style="color:#000;font-weight:bold">.</span>data)
</span></span><span style="display:flex;"><span>      rv <span style="color:#000;font-weight:bold">=</span> <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>app<span style="color:#000;font-weight:bold">.</span>get(<span style="color:#d14">&#39;/d&#39;</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">assert</span> <span style="color:#0086b3">len</span>(json<span style="color:#000;font-weight:bold">.</span>loads(rv<span style="color:#000;font-weight:bold">.</span>data)) <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">10</span>
</span></span></code></pre></div><p>These three test-cases cover basic functionality of the high-score
tracker:</p>
<ul>
<li>Ensure that if a GET request is made before adding entries an empty
JSON array is returned.</li>
<li>If a single entry is added with a POST ensure that the same results
are returned with a GET.</li>
<li>If there are more than 10 entries added ensure that we only get 10
back.</li>
</ul>
<p>For the actual app there isn&rsquo;t much more code than what was written for
the tests.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>  <span style="color:#3c5d5d;font-weight:bold">@app.route</span>(<span style="color:#d14">&#39;/d&#39;</span>, methods<span style="color:#000;font-weight:bold">=</span>[<span style="color:#d14">&#39;GET&#39;</span>])
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">get_scores</span>():
</span></span><span style="display:flex;"><span>      results <span style="color:#000;font-weight:bold">=</span> g<span style="color:#000;font-weight:bold">.</span>db<span style="color:#000;font-weight:bold">.</span>execute(
</span></span><span style="display:flex;"><span>          <span style="color:#d14">&#39;select name, score, time from hs order by score limit 10&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      q <span style="color:#000;font-weight:bold">=</span> [<span style="color:#0086b3">dict</span>(<span style="color:#0086b3">zip</span>([<span style="color:#d14">&#39;name&#39;</span>, <span style="color:#d14">&#39;score&#39;</span>, <span style="color:#d14">&#39;time&#39;</span>], [item <span style="color:#000;font-weight:bold">for</span> item <span style="color:#000;font-weight:bold">in</span> row]))
</span></span><span style="display:flex;"><span>           <span style="color:#000;font-weight:bold">for</span> row <span style="color:#000;font-weight:bold">in</span> results]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">return</span> json<span style="color:#000;font-weight:bold">.</span>dumps(q)
</span></span></code></pre></div><p>Retrieve the top 10 scores, return the results as JSON.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>  <span style="color:#3c5d5d;font-weight:bold">@app.route</span>(<span style="color:#d14">&#39;/d&#39;</span>, methods<span style="color:#000;font-weight:bold">=</span>[<span style="color:#d14">&#39;POST&#39;</span>])
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">post_score</span>():
</span></span><span style="display:flex;"><span>      data <span style="color:#000;font-weight:bold">=</span> request<span style="color:#000;font-weight:bold">.</span>form
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">not</span> re<span style="color:#000;font-weight:bold">.</span><span style="color:#000;font-weight:bold">match</span>(<span style="color:#d14">&#39;[\s\w]{1,20}$&#39;</span>, data[<span style="color:#d14">&#39;name&#39;</span>])):
</span></span><span style="display:flex;"><span>          <span style="color:#000;font-weight:bold">return</span> json<span style="color:#000;font-weight:bold">.</span>dumps({<span style="color:#d14">&#39;error&#39;</span>: <span style="color:#d14">&#39;invalid name&#39;</span>})
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">not</span> re<span style="color:#000;font-weight:bold">.</span><span style="color:#000;font-weight:bold">match</span>(<span style="color:#d14">&#39;[0-9]+\.?[0-9]*$&#39;</span>, data[<span style="color:#d14">&#39;time&#39;</span>])):
</span></span><span style="display:flex;"><span>          <span style="color:#000;font-weight:bold">return</span> json<span style="color:#000;font-weight:bold">.</span>dumps({<span style="color:#d14">&#39;error&#39;</span>: <span style="color:#d14">&#39;invalid time&#39;</span>})
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">not</span> re<span style="color:#000;font-weight:bold">.</span><span style="color:#000;font-weight:bold">match</span>(<span style="color:#d14">&#39;[0-9]{1,15}$&#39;</span>, data[<span style="color:#d14">&#39;score&#39;</span>])):
</span></span><span style="display:flex;"><span>          <span style="color:#000;font-weight:bold">return</span> json<span style="color:#000;font-weight:bold">.</span>dumps({<span style="color:#d14">&#39;error&#39;</span>: <span style="color:#d14">&#39;invalid score&#39;</span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      g<span style="color:#000;font-weight:bold">.</span>db<span style="color:#000;font-weight:bold">.</span>execute(<span style="color:#d14">&#39;insert into hs (name, score, time) values (?, ?, ?)&#39;</span>,
</span></span><span style="display:flex;"><span>                   [data[<span style="color:#d14">&#39;name&#39;</span>], data[<span style="color:#d14">&#39;score&#39;</span>], data[<span style="color:#d14">&#39;time&#39;</span>]])
</span></span><span style="display:flex;"><span>      g<span style="color:#000;font-weight:bold">.</span>db<span style="color:#000;font-weight:bold">.</span>commit()
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">return</span> json<span style="color:#000;font-weight:bold">.</span>dumps({<span style="color:#d14">&#39;ok&#39;</span>: <span style="color:#d14">&#39;success&#39;</span>})
</span></span></code></pre></div><p>Receive a new score, do some basic input validation and insert the new
high score entry.</p>
<p>Of course it&rsquo;s easy to inject fake high scores with something like this,
abuse it, cheat, etc. But in this case it&rsquo;s just for fun.</p>

</article>


        </main>
        <footer></footer>
    </body>
</html>
