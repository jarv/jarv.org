image: registry.gitlab.com/jarv/jarv.org/ci-image:latest

stages:
  - image
  - deploy

.image:
  stage: image
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: tcp://docker:2375
  services:
    - docker:19.03.5-dind
  before_script:
    - 'echo Running: docker login --password-stdin -u $CI_REGISTRY_USER $CI_REGISTRY'
    - 'echo ${CI_JOB_TOKEN} | docker login --password-stdin -u $CI_REGISTRY_USER $CI_REGISTRY'

image:ci:manual:
  image: docker:19.03.8
  extends: .image
  allow_failure: true
  when: manual
  script:
    - apk add make git
    - make push-image-ci

.deploy:
  stage: deploy
  script:
    - make clean
    - export S3_BUCKET=$S3_BUCKET
    - export DISTID=$DISTID
    - make s3_upload

before_script:
  - git submodule update --init --recursive
  - pip install -r requirements.txt

deploy:draft:
  extends: .deploy
  resource_group: deploy:draft
  variables:
    S3_BUCKET: draft.jarv.org
    DISTID: E1B0Q0MMPJQ79F
  environment:
    name: draft
    url: https://draft.jarv.org

deploy:prod:
  extends: .deploy
  resource_group: deploy:prod
  variables:
    S3_BUCKET: jarv.org
    DISTID: EEN9NFVIDRTGS
  environment:
    name: jarv
    url: https://jarv.org
  when: manual
